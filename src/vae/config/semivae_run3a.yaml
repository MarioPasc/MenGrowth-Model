# =============================================================================
# Semi-Supervised VAE Configuration - Run 3A
# =============================================================================
# Goal: Improve semantic supervision quality while preserving z_residual activity
#
# Key changes from Run 1 (20260119):
# - Increased semantic lambdas: vol=15, loc=10, shape=15
# - Reduced z_shape dims: 24 → 12 (6 features × 2 redundancy)
# - Reduced TC penalty: 2.0 → 0.5, delayed to epoch 50
# - Disabled manifold penalty to allow z_residual to encode information
# - Extended training to 400 epochs
#
# Expected outcomes:
# - Vol R²: 0.72 → 0.85+
# - Loc R²: 0.83 → 0.90+
# - Shape R²: 0.22 → 0.40+
# - z_residual AU: 0 → 10+ (if successful)
#
# Hardware target: 2x GPU (A100 or similar with 40GB+ VRAM)
# =============================================================================

data:
  root_dir: "/media/mpascual/PortableSSD/Meningiomas/BraTS/BraTS_Men_Train"
  modalities: ["t1c", "t1n", "t2f", "t2w"]
  roi_size: [128, 128, 128]
  spacing: [1.875, 1.875, 1.875]
  orientation: "RAS"

  batch_size: 4
  num_workers: 8
  cache_rate: 1.0
  val_split: 0.1
  test_split: 0.1
  persistent_cache_subdir: "cache_semivae"

  extract_semantic_features: true
  semantic_feature_normalization: "z_score"

model:
  variant: "semivae"
  z_dim: 128
  input_channels: 4
  base_filters: 32
  num_groups: 8
  norm: "GROUP"

  use_sbd: true
  sbd_grid_size: [8, 8, 8]
  sbd_upsample_mode: "resize_conv"

  architecture:
    pre_activation: false
    blocks_per_layer: [2, 2, 2, 2]
    upsample_mode: "resize_conv"

  use_spectral_norm: true

  # ==========================================================================
  # LATENT PARTITIONING - Run 3A Configuration
  # ==========================================================================
  # z = [z_vol(16) | z_loc(12) | z_shape(12) | z_residual(88)]
  #     dims 0-15     16-27       28-39          40-127
  #
  # Changes from Run 1:
  # - z_shape reduced: 24 → 12 dims (6 features × 2 redundancy)
  # - z_residual increased: 76 → 88 dims (uses freed shape dims)
  # ==========================================================================
  latent_partitioning:
    enabled: true

    # Volume encoding (4 features × 4 redundant dims = 16)
    z_vol:
      start_idx: 0
      dim: 16
      supervision: "regression"
      target_features: ["vol_total", "vol_ncr", "vol_ed", "vol_et"]

    # Location encoding (3 features × 4 redundant dims = 12)
    z_loc:
      start_idx: 16
      dim: 12
      supervision: "regression"
      target_features: ["loc_x", "loc_y", "loc_z"]

    # Shape encoding - REDUCED dims (12 features → 12 dims, 1:1 mapping)
    # Same 12 features as original, but with fewer redundant dims
    # This forces a more compact representation
    z_shape:
      start_idx: 28
      dim: 12  # REDUCED from 24 (was 12 features × 2 redundancy)
      supervision: "regression"
      target_features:
        - "sphericity_total"
        - "sphericity_ncr"
        - "sphericity_et"
        - "surface_area_total"
        - "surface_area_ncr"
        - "surface_area_et"
        - "aspect_xy_total"
        - "aspect_xz_total"
        - "aspect_xy_ncr"
        - "aspect_xz_ncr"
        - "solidity_total"
        - "solidity_et"

    # Residual encoding - INCREASED (to use freed shape dims)
    z_residual:
      start_idx: 40  # Changed from 52
      dim: 88        # INCREASED from 76
      supervision: "none"

loss:
  reduction: "mean"

  # ==========================================================================
  # SEMANTIC SUPERVISION LOSSES - INCREASED
  # ==========================================================================
  # Rationale: Higher lambdas in Run 1 produced better R² values
  # Run 1: vol=10, loc=5, shape=5 → Vol R²=0.72, Loc R²=0.83, Shape R²=0.23
  # Run 2: vol=2, loc=1, shape=1 → Vol R²=0.69, Loc R²=0.75, Shape R²=0.20
  # Run 3A: vol=15, loc=10, shape=15 → Target: Vol R²>0.85, Loc R²>0.9, Shape R²>0.4
  lambda_vol: 15.0           # Increased from 10.0 (+50%)
  lambda_loc: 10.0           # Increased from 5.0 (+100%)
  lambda_shape: 15.0         # Increased from 5.0 (+200%, compensates for fewer dims)

  # Semantic supervision schedule - earlier start
  # Phase 1 (0-14): Pure VAE warmup
  # Phase 2 (15-39): Linear warmup of semantic losses
  # Phase 3 (40+): Full semantic supervision
  semantic_start_epoch: 15   # Earlier than Run 2 (was 30)
  semantic_annealing_epochs: 25  # Shorter than Run 2 (was 40)

  # ==========================================================================
  # CROSS-PARTITION INDEPENDENCE LOSS - REDUCED
  # ==========================================================================
  # Rationale: Strong cross-partition loss contributed to z_residual collapse
  # by pushing all partitions toward independence before residual could learn
  lambda_cross_partition: 2.0  # Same as Run 2
  cross_partition_start_epoch: 30  # Delayed (same as Run 2)

  # ==========================================================================
  # MANIFOLD DENSITY REGULARIZATION - DISABLED
  # ==========================================================================
  # Rationale: Manifold loss explicitly pushes z_residual toward N(0,I),
  # which combined with TC loss causes complete collapse (0 AU observed).
  # Disabling allows z_residual to encode meaningful information.
  lambda_manifold: 0.0  # DISABLED (was 0.5)
  manifold_start_epoch: 30

  # ==========================================================================
  # RESIDUAL REGULARIZATION - REDUCED AND DELAYED
  # ==========================================================================
  # Rationale: Strong TC (λ=2.0) starting at epoch 10/30 pushed z_residual
  # to factorial prior before it could learn anything useful.
  #
  # Changes:
  # - λ_tc: 2.0 → 0.5 (75% reduction)
  # - tc_start_epoch: 30 → 50 (much later start)
  use_tc_residual: true
  lambda_tc: 0.5              # REDUCED from 2.0
  tc_estimator: "minibatch_weighted"
  tc_start_epoch: 50          # DELAYED from 30 (after semantic is stable)
  tc_annealing_epochs: 30

  use_ddp_gather: true
  compute_in_fp32: true

train:
  seed: 42
  max_epochs: 400            # EXTENDED from 300 for better convergence
  lr: 1e-4
  weight_decay: 0.01
  precision: "bf16-mixed"
  gradient_checkpointing: true
  accelerator: "gpu"

  devices: 2
  strategy: "ddp"
  sync_batchnorm: true
  deterministic: false

  loss_reduction: "mean"
  gradient_clip_val: 2.0     # RELAXED from 1.0 (allow larger gradients from stronger semantic loss)
  gradient_clip_algorithm: "norm"
  posterior_logvar_min: -6.0

  # KL on residual dimensions
  kl_beta: 1.0
  kl_annealing_epochs: 200
  kl_annealing_type: "cyclical"
  kl_annealing_cycles: 4
  kl_annealing_ratio: 0.5

  kl_free_bits: 0.2
  kl_free_bits_mode: "batch_mean"

  kl_beta_supervised: 0.0
  kl_supervised_free_bits: 0.05

  log_collapse_diagnostics: true
  warmup_epochs: 15  # Match semantic_start_epoch

logging:
  save_dir: "experiments/runs"
  run_tag: "run3a"  # Tag for identification
  log_every_n_steps: 50

  logger:
    type: "wandb"
    wandb:
      project: "mengrowth-semivae"
      entity: "mario-pg02-icai"
      name: null
      tags: ["semivae", "meningioma", "semi-supervised", "exp3", "run3a"]
      notes: "Run 3A: Increased semantic lambdas, reduced z_shape dims (12), delayed TC, disabled manifold"
      offline: true
      save_code: true
      log_model: false

  checkpointing:
    save_top_k: 3
    monitor: "val_epoch/loss"
    mode: "min"
    save_last: true
    every_n_epochs: 1
    filename: "semivae-{epoch:04d}"

  visual:
    log_reconstructions: true
    recon_every_n_epochs: 5
    num_recon_samples: 2
    log_dashboard: true
    dashboard_every_n_epochs: 10
    log_latent_viz: true
    latent_viz_every_n_epochs: 20
    latent_viz_n_samples: 256

  min_logs_per_epoch: 3

  latent_diag_every_n_epochs: 10
  latent_diag_num_samples: 128
  latent_diag_shift_vox: 5
  latent_diag_ids_name: "diagnostics/latent_probes/ids.txt"

  au_dense_until: 30
  au_sparse_interval: 5
  au_subset_fraction: 0.5
  au_batch_size: 32
  eps_au: 0.01
  au_subset_seed: 42
  au_residual_only: true

  seg_labels:
    ncr: 1
    ed: 2
    et: 3

  log_grad_norm: true

  semivae_diag_every_n_epochs: 10
  semivae_diag_num_samples: 100
  semivae_visualize_latent: true
  semivae_viz_every_n_epochs: 25

  log_semantic_metrics: true
  semantic_metrics:
    - "sem/vol_mse"
    - "sem/vol_r2"
    - "sem/loc_mse"
    - "sem/loc_r2"
    - "sem/shape_mse"
    - "sem/shape_r2"
    - "sem/total_supervised_loss"
