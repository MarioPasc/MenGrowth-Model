# =============================================================================
# SemiVAE Run 6 - "Structural Independence"
# =============================================================================
# Root cause fixes from Runs 4 & 5 analysis:
#   1. Replace cross-partition (Pearson on means) with Distance Correlation
#   2. Gradient isolation: semantic losses only update their own partition
#   3. Remove TC loss (caused instability, served no purpose on z_residual)
#   4. Auxiliary residual decoder (prevents z_residual deflation)
#   5. Shape residualization (removes natural vol-shape confound)
#   6. Lambda decay phase (releases encoder capacity in late training)
#
# Expected outcomes:
#   - Vol R² > 0.85 (gradient isolation prevents contamination)
#   - Loc R² > 0.91 (cleaner gradient signal)
#   - Shape R² > 0.40 (residualized targets easier to predict)
#   - max|dCor| < 0.35 (dCor with 256 buffer detects true dependence)
#   - z_residual AU > 0.60 (auxiliary decoder prevents collapse)
# =============================================================================

data:
  root_dir: /mnt/home/users/tic_163_uma/mpascual/fscratch/datasets/meningiomas/brats_men
  modalities: [t1c, t1n, t2f, t2w]
  roi_size: [160, 160, 160]
  spacing: [1.25, 1.25, 1.25]
  orientation: RAS
  batch_size: 2
  num_workers: 8
  cache_rate: 1.0
  val_split: 0.1
  test_split: 0.1
  persistent_cache_subdir: "cache_semivae_run6"

  extract_semantic_features: true
  semantic_feature_normalization: z_score

  # Shape residualization (remove vol-shape confound)
  # residual_params_path is overridden by the SLURM script at runtime
  residualize_shape: true
  residual_params_path: "__RESIDUAL_PARAMS_PATH__"

model:
  variant: semivae
  z_dim: 128
  input_channels: 4
  base_filters: 32
  num_groups: 8
  norm: GROUP

  use_sbd: true
  sbd_grid_size: [10, 10, 10]
  sbd_upsample_mode: resize_conv

  architecture:
    pre_activation: false
    blocks_per_layer: [2, 2, 2, 2]
    upsample_mode: resize_conv

  use_spectral_norm: true

  # ==========================================================================
  # LATENT PARTITIONING - Same layout as Run 5
  # ==========================================================================
  latent_partitioning:
    enabled: true

    # Volume encoding - 4 features x 6 dims = 24
    z_vol:
      start_idx: 0
      dim: 24
      supervision: "regression"
      target_features: ["vol_total", "vol_ncr", "vol_ed", "vol_et"]

    # Location encoding - 3 features x ~2.7 dims = 8
    z_loc:
      start_idx: 24
      dim: 8
      supervision: "regression"
      target_features: ["loc_x", "loc_y", "loc_z"]

    # Shape encoding - 6 RESIDUALIZED features x 2 dims = 12
    z_shape:
      start_idx: 32
      dim: 12
      supervision: "regression"
      target_features:
        - "sphericity_total"
        - "surface_area_total"
        - "solidity_total"
        - "aspect_xy_total"
        - "sphericity_ncr"
        - "surface_area_ncr"

    # Residual encoding
    z_residual:
      start_idx: 44
      dim: 84
      supervision: "none"

    # Enable auxiliary residual decoder (prevents z_residual deflation)
    aux_residual_decoder: true

# =============================================================================
# LOSS CONFIGURATION - Structural Independence
# =============================================================================
loss:
  reduction: mean

  # --------------------------------------------------------------------------
  # SEMANTIC SUPERVISION (with gradient isolation)
  # --------------------------------------------------------------------------
  gradient_isolation: true

  lambda_vol: 20.0
  vol_start_epoch: 30
  vol_annealing_epochs: 40

  lambda_loc: 12.0
  loc_start_epoch: 80
  loc_annealing_epochs: 40

  lambda_shape: 15.0
  shape_start_epoch: 120
  shape_annealing_epochs: 50

  # Legacy fallback
  semantic_start_epoch: 30
  semantic_annealing_epochs: 40

  # --------------------------------------------------------------------------
  # LAMBDA DECAY (after learning plateaus, releases encoder capacity)
  # --------------------------------------------------------------------------
  sem_decay_start_epoch: 400
  sem_decay_target_fraction: 0.5
  sem_decay_epochs: 150

  # --------------------------------------------------------------------------
  # DISTANCE CORRELATION (replaces broken cross-partition Pearson loss)
  # Uses full multivariate vectors + EMA buffer for N_eff=256
  # --------------------------------------------------------------------------
  lambda_dcor: 5.0
  dcor_start_epoch: 150
  dcor_annealing_epochs: 50
  dcor_buffer_size: 256

  # --------------------------------------------------------------------------
  # CROSS-PARTITION: DISABLED (replaced by dCor)
  # --------------------------------------------------------------------------
  lambda_cross_partition: 0.0
  cross_partition_start_epoch: 9999

  # --------------------------------------------------------------------------
  # MANIFOLD: DISABLED (contributes to residual collapse)
  # --------------------------------------------------------------------------
  lambda_manifold: 0.0
  manifold_start_epoch: 9999

  # --------------------------------------------------------------------------
  # TC: DISABLED (60% of loss, gradient spikes to 485k, no downstream use)
  # --------------------------------------------------------------------------
  use_tc_residual: false
  lambda_tc: 0.0
  tc_start_epoch: 9999
  tc_annealing_epochs: 50

  # --------------------------------------------------------------------------
  # AUXILIARY RESIDUAL RECONSTRUCTION (prevents z_residual deflation)
  # Lightweight 64^3 decoder from z_residual only
  # --------------------------------------------------------------------------
  lambda_aux_recon: 0.5
  aux_recon_target_size: 64

  # DDP settings
  use_ddp_gather: true
  compute_in_fp32: true

# =============================================================================
# TRAINING CONFIGURATION
# =============================================================================
train:
  seed: 42
  max_epochs: 600
  lr: 5e-5
  weight_decay: 0.01
  precision: bf16-mixed
  gradient_checkpointing: true

  accelerator: gpu
  devices: 4
  strategy: ddp
  sync_batchnorm: true
  deterministic: false

  loss_reduction: mean
  gradient_clip_val: 1.0         # Tighter clip (no TC spikes possible)
  gradient_clip_algorithm: norm

  posterior_logvar_min: -6.0

  # KL annealing (cyclical, 4 cycles over 240 epochs)
  kl_beta: 1.0
  kl_annealing_epochs: 240
  kl_annealing_type: cyclical
  kl_annealing_cycles: 4
  kl_annealing_ratio: 0.5

  # Free bits
  kl_free_bits: 0.2
  kl_free_bits_mode: batch_mean

  # KL on supervised (disabled: gradient isolation handles separation)
  kl_beta_supervised: 0.0
  kl_supervised_free_bits: 0.05

  log_collapse_diagnostics: true
  warmup_epochs: 20

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
logging:
  save_dir: /mnt/home/users/tic_163_uma/mpascual/fscratch/results/semivae
  run_tag: run6_structural
  log_every_n_steps: 50

  logger:
    type: wandb
    wandb:
      project: mengrowth-semivae
      entity: mario-pg02-icai
      name: null
      tags:
        - semivae
        - exp3
        - run6
        - dcor
        - gradient-isolation
        - aux-decoder
        - shape-residualization
      notes: >
        Run 6: Structural fixes. dCor replaces broken cross-partition loss,
        gradient isolation prevents inter-partition leakage,
        auxiliary decoder prevents z_residual collapse,
        shape residualization removes natural vol-shape confound.
      offline: true
      save_code: true
      log_model: false

  checkpointing:
    save_top_k: 3
    monitor: val_epoch/ode_readiness
    mode: max
    save_last: true
    every_n_epochs: 1
    filename: "semivae-{epoch:04d}"

  visual:
    log_reconstructions: true
    recon_every_n_epochs: 10
    num_recon_samples: 2
    log_dashboard: true
    dashboard_every_n_epochs: 20
    log_latent_viz: true
    latent_viz_every_n_epochs: 50
    latent_viz_n_samples: 256

  min_logs_per_epoch: 3
  latent_diag_every_n_epochs: 10
  latent_diag_num_samples: 128
  latent_diag_shift_vox: 5

  # Active units diagnostics
  au_dense_until: 100
  au_sparse_interval: 10
  au_subset_fraction: 0.75
  au_batch_size: 16
  eps_au: 0.01
  au_subset_seed: 42
  au_residual_only: true

  seg_labels:
    ncr: 1
    ed: 2
    et: 3

  log_grad_norm: true

  # SemiVAE-specific diagnostics
  semivae_diag_every_n_epochs: 10
  semivae_diag_num_samples: 100
  semivae_visualize_latent: true
  semivae_viz_every_n_epochs: 50
  log_semantic_metrics: true
  semantic_metrics:
    - sem/vol_mse
    - sem/vol_r2
    - sem/loc_mse
    - sem/loc_r2
    - sem/shape_mse
    - sem/shape_r2
    - sem/total_supervised_loss
