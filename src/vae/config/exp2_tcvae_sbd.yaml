data:
  root_dir: "/media/mpascual/PortableSSD/Meningiomas/BraTS/BraTS_Men_Train"
  modalities: ["t1c", "t1n", "t2f", "t2w"]
  roi_size: [128, 128, 128]
  spacing: [1.875, 1.875, 1.875]
  orientation: "RAS"
  batch_size: 8
  num_workers: 4
  cache_rate: 1.0
  val_split: 0.1
  persistent_cache_subdir: "cache"

model:
  variant: "tcvae_sbd"
  z_dim: 128
  input_channels: 4
  base_filters: 32
  norm: "GROUP"
  sbd_grid_size: [8, 8, 8]

loss:
  alpha: 1.0
  gamma: 1.0
  beta_tc_target: 6.0
  beta_tc_annealing_epochs: 40
  compute_in_fp32: true
  reduction: "mean"  # Use mean reduction for numerical stability

train:
  seed: 42
  max_epochs: 200
  lr: 1e-4
  precision: "16-mixed"
  gradient_checkpointing: true
  accelerator: "gpu"
  devices: 1

  # Numerical stability settings for FP16 mixed precision
  loss_reduction: "mean"  # Use mean reduction instead of sum for numerical stability
  gradient_clip_val: 1.0  # Clip gradient L2 norm to prevent FP16 overflow
  gradient_clip_algorithm: "norm"  # Gradient clipping algorithm: "norm" or "value"

  # Free bits (per-dimension KL threshold for posterior collapse mitigation)
  kl_free_bits: 0.05  # nats per dimension (0.0 = disabled)
                     # With batch_mean mode and z_dim=128: floor ≈ 128 × 0.05 = 6.4 nats
                     # Recommended range: 0.05-0.2 based on KL/recon balance
                     # Start with 0.1 and adjust if posterior collapse persists
  kl_free_bits_mode: "batch_mean"  # "per_sample" or "batch_mean"
                                   # batch_mean: weaker, better for small batches (B=2)
                                   # per_sample: stronger, uniform floor across samples

logging:
  save_dir: "experiments/runs"
  recon_every_n_epochs: 5
  num_recon_samples: 2
  min_logs_per_epoch: 3  # Minimum console/CSV log entries per training epoch
